<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - Lifeline</title>
    <link rel="stylesheet" href="/static/styles.css?v=20260204">
    <style>
        .kanban-task.drag-over {
            border-style: dashed;
            border-color: var(--accent-primary);
        }
        .kanban-column.drag-over {
            background: rgba(124, 58, 237, 0.05);
            border-color: var(--accent-primary);
        }
        .drop-placeholder {
            height: 80px;
            border: 2px dashed var(--accent-primary);
            border-radius: var(--radius-md);
            background: rgba(124, 58, 237, 0.1);
            margin-bottom: 0.75rem;
        }
        /* Transition control styles */
        .kanban-column.drag-source {
            opacity: 0.7;
        }
        .kanban-column.drag-allowed {
            border-color: var(--success);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }
        .kanban-column.drag-allowed .column-header {
            background: rgba(16, 185, 129, 0.1);
        }
        .kanban-column.drag-forbidden {
            opacity: 0.5;
            border-color: var(--error);
        }
        .kanban-column.drag-forbidden .column-tasks {
            pointer-events: none;
        }
        .kanban-column.drag-forbidden::after {
            content: 'üö´';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            opacity: 0.3;
        }
        .kanban-column {
            position: relative;
        }
        /* Column drag-and-drop styles */
        .column-drag-handle {
            cursor: grab;
            padding: 4px;
            margin-right: 8px;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .column-drag-handle:hover {
            opacity: 1;
        }
        .kanban-column.column-dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .kanban-column.column-drag-over {
            border-color: var(--accent-primary);
            background: rgba(124, 58, 237, 0.05);
        }
        .stage-item.drag-over {
            border-color: var(--accent-primary);
            background: rgba(124, 58, 237, 0.1);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/projects" class="navbar-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span class="gradient-text">Lifeline</span>
            </a>
            <div class="navbar-nav">
                <a href="/projects" class="nav-link">–ü—Ä–æ–µ–∫—Ç—ã</a>
                <a href="#" class="nav-link" id="projectLink">–ó–∞–¥–∞—á–∏</a>
                <a href="#" class="nav-link active">Kanban</a>
                <a href="/users" class="nav-link" id="usersNavLink" style="display: none;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                <a href="/settings" class="nav-link" id="settingsNavLink" style="display: none;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</a>
            </div>
            <div class="user-menu"></div>
        </div>
    </nav>
    
    <div class="kanban-container">
        <div class="kanban-header">
            <h1 id="projectTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="flex gap-2">
                <a id="listLink" href="#" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    –°–ø–∏—Å–æ–∫
                </a>
                <a id="historyLink" href="#" class="btn btn-secondary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        <line x1="8" y1="7" x2="16" y2="7"/>
                        <line x1="8" y1="11" x2="16" y2="11"/>
                        <line x1="8" y1="15" x2="12" y2="15"/>
                    </svg>
                    –õ–µ–Ω—Ç–∞
                </a>
                <button class="btn btn-primary" onclick="openCreateTask()" style="display: none !important;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="kanban-filters" style="display: flex; flex-wrap: wrap; gap: 0.75rem; padding: 1rem 0; align-items: center;">
            <div class="search-input" style="position: relative; flex: 1; min-width: 200px; max-width: 300px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--text-secondary);">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                </svg>
                <input type="text" class="form-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." style="padding-left: 40px;">
            </div>
            <select class="form-select" id="authorFilter" style="width: auto; min-width: 140px; display: none;">
                <option value="">–í—Å–µ –∞–≤—Ç–æ—Ä—ã</option>
            </select>
            <select class="form-select" id="assigneeFilter" style="width: auto; min-width: 140px;">
                <option value="">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>
            </select>
            <select class="form-select" id="priorityFilter" style="width: auto; min-width: 140px;">
                <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                <option value="0">–ù–∏–∑–∫–∏–π</option>
                <option value="1">–û–±—ã—á–Ω—ã–π</option>
                <option value="2">–í—ã—Å–æ–∫–∏–π</option>
                <option value="3">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
            </select>
            <label class="checkbox-label" id="onlyMineLabel" style="margin-left: 1rem; display: none; align-items: center; gap: 0.5rem; cursor: pointer; white-space: nowrap;">
                <input type="checkbox" id="onlyMine" onchange="onOnlyMineChange()">
                <span>–¢–æ–ª—å–∫–æ –º–æ–∏</span>
            </label>
        </div>
        
        <div id="kanbanBoard" class="kanban-board">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </div>
    
    <!-- Create Task Modal -->
    <div class="modal-overlay" id="createTaskModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
                <button class="modal-close" onclick="closeModal('createTaskModal')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="createTaskForm">
                <div class="modal-body">
                    <input type="hidden" id="taskStageId">
                    <div class="form-group">
                        <label class="form-label" for="taskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="taskTitle" class="form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="taskDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="taskDescription" class="form-textarea" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"></textarea>
                    </div>
                    <div class="form-group" id="taskAssigneeGroup">
                        <label class="form-label" for="taskAssignee">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                        <select id="taskAssignee" class="form-select">
                            <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="taskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select id="taskPriority" class="form-select">
                            <option value="0">–ù–∏–∑–∫–∏–π</option>
                            <option value="1" selected>–û–±—ã—á–Ω—ã–π</option>
                            <option value="2">–í—ã—Å–æ–∫–∏–π</option>
                            <option value="3">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                        </select>
                    </div>
                    <div id="customFieldsCreate"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createTaskModal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary" id="createTaskSubmitBtn" style="display: none;">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Task Modal with Tabs -->
    <div class="modal-overlay" id="editTaskModal">
        <div class="modal" style="max-width: min(1200px, 95vw); max-height: min(90vh, 900px); width: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3 class="modal-title">–ó–∞–¥–∞—á–∞ <span id="editTaskIdLabel">#</span></h3>
                <button class="modal-close" onclick="closeTaskModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <!-- Task Tabs -->
            <div class="task-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); padding: 0 1.5rem;">
                <button type="button" class="task-tab active" data-tab="main" onclick="switchTaskTab('main')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    –û—Å–Ω–æ–≤–Ω–æ–µ
                </button>
                <button type="button" class="task-tab" data-tab="params" onclick="switchTaskTab('params')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
                </button>
                <button type="button" class="task-tab" data-tab="extra" onclick="switchTaskTab('extra')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <path d="M12 3v18M3 12h18"/>
                    </svg>
                    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
                </button>
                <button type="button" class="task-tab" data-tab="links" onclick="switchTaskTab('links')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    –°–≤—è–∑–∏
                    <span id="linksBadge" class="chat-badge" style="display: none;">0</span>
                </button>
                <button type="button" class="task-tab" data-tab="chat" onclick="switchTaskTab('chat')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    –ß–∞—Ç
                    <span id="chatBadge" class="chat-badge" style="display: none;">0</span>
                </button>
                <button type="button" class="task-tab" data-tab="files" onclick="switchTaskTab('files')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                    </svg>
                    –§–∞–π–ª—ã
                    <span id="filesBadge" class="chat-badge" style="display: none;">0</span>
                </button>
                <button type="button" class="task-tab" data-tab="history" onclick="switchTaskTab('history')">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    –ò—Å—Ç–æ—Ä–∏—è
                </button>
            </div>
            
            <form id="editTaskForm">
                <!-- Main Tab Content -->
                <div class="task-tab-content active" id="taskTabMain">
                    <div class="modal-body">
                        <input type="hidden" id="editTaskId">
                        
                        <!-- Task Info: Author and Created Date -->
                        <div class="task-info-bar" style="display: flex; gap: 2rem; padding: 0.75rem 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 1rem; font-size: 0.875rem;">
                            <div>
                                <span class="text-secondary">–ê–≤—Ç–æ—Ä:</span>
                                <span id="editTaskAuthor" style="margin-left: 0.5rem;">‚Äî</span>
                            </div>
                            <div>
                                <span class="text-secondary">–°–æ–∑–¥–∞–Ω–æ:</span>
                                <span id="editTaskCreatedAt" style="margin-left: 0.5rem;">‚Äî</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="editTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="editTaskTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="editTaskDescription" class="form-textarea"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Params Tab Content -->
                <div class="task-tab-content" id="taskTabParams">
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label" for="editTaskStage">–≠—Ç–∞–ø</label>
                            <select id="editTaskStage" class="form-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editTaskAssignee">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                            <select id="editTaskAssignee" class="form-select">
                                <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editTaskPriority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select id="editTaskPriority" class="form-select">
                                <option value="0">–ù–∏–∑–∫–∏–π</option>
                                <option value="1">–û–±—ã—á–Ω—ã–π</option>
                                <option value="2">–í—ã—Å–æ–∫–∏–π</option>
                                <option value="3">–ö—Ä–∏—Ç–∏—á–Ω—ã–π</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="editTaskDueDate">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                            <input type="date" id="editTaskDueDate" class="form-input">
                        </div>
                    </div>
                </div>
                
                <!-- Extra Tab Content (Custom Fields) -->
                <div class="task-tab-content" id="taskTabExtra">
                    <div class="modal-body">
                        <div id="customFieldsEdit"></div>
                        <div id="noCustomFields" class="text-center text-secondary py-4" style="display: none;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 1rem; opacity: 0.3;">
                                <path d="M12 3v18M3 12h18"/>
                            </svg>
                            <p>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</p>
                        </div>
                    </div>
                </div>
                
                <!-- Chat Tab Content -->
                <div class="task-tab-content" id="taskTabChat">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                        </div>
                        <div class="chat-input-area" style="display: none;">
                            <div class="chat-input-wrapper">
                                <textarea id="chatInput" class="chat-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                                <div class="chat-input-actions">
                                    <button type="button" class="chat-action-btn" onclick="toggleEmojiPicker(event)" title="–°–º–∞–π–ª–∏–∫–∏">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                            <line x1="9" y1="9" x2="9.01" y2="9"/>
                                            <line x1="15" y1="9" x2="15.01" y2="9"/>
                                        </svg>
                                    </button>
                                    <input type="file" id="chatImageInput" accept="image/*" style="display: none;" onchange="uploadChatImage(this)">
                                    <button type="button" class="chat-action-btn" onclick="document.getElementById('chatImageInput').click()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21 15 16 10 5 21"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary chat-send-btn" onclick="sendComment()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                            </button>
                            <div id="emojiPicker" class="emoji-picker" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Files Tab Content -->
                <div class="task-tab-content" id="taskTabFiles">
                    <div class="modal-body">
                        <div id="taskAttachments" class="files-grid"></div>
                        <div class="mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                            <input type="file" id="attachmentInput" style="display: none;" multiple>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('attachmentInput').click()" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                                </svg>
                                –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                            <span id="uploadProgress" class="text-secondary ml-2" style="font-size: 0.85rem;"></span>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab Content -->
                <div class="task-tab-content" id="taskTabHistory">
                    <div class="modal-body">
                        <div id="taskHistoryList">
                            <div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Links Tab Content -->
                <div class="task-tab-content" id="taskTabLinks">
                    <div class="modal-body">
                        <!-- Add Link Form -->
                        <div class="add-link-form" id="addLinkForm" style="display: none; padding: 1rem; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 0.95rem;">–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å</h4>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <select id="linkType" class="form-select" style="width: auto; min-width: 160px;">
                                    <option value="relates">–°–≤—è–∑–∞–Ω–∞ —Å</option>
                                    <option value="blocks">–ë–ª–æ–∫–∏—Ä—É–µ—Ç</option>
                                    <option value="blocked_by">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞</option>
                                    <option value="duplicates">–î—É–±–ª–∏—Ä—É–µ—Ç</option>
                                    <option value="duplicated_by">–î—É–±–ª–∏—Ä—É–µ—Ç—Å—è</option>
                                    <option value="parent">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –¥–ª—è</option>
                                    <option value="child">–î–æ—á–µ—Ä–Ω—è—è –æ—Ç</option>
                                </select>
                                <input type="text" id="linkTaskSearch" class="form-input" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ #ID" style="flex: 1; min-width: 200px;">
                                <button type="button" class="btn btn-primary" onclick="addTaskLink()">–°–≤—è–∑–∞—Ç—å</button>
                                <button type="button" class="btn btn-success" onclick="createLinkedTask()" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–≤—è–∑–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                        <path d="M12 5v14M5 12h14"/>
                                    </svg>
                                    –°–æ–∑–¥–∞—Ç—å
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideLinkForm()">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                            <div id="linkTaskResults" style="margin-top: 0.75rem; max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; font-size: 1rem;">–°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <button type="button" class="btn btn-sm btn-secondary" id="showLinksMapBtn" onclick="openTaskLinksMap()" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ —Å–≤—è–∑–µ–π">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    –ö–∞—Ä—Ç–∞
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" id="showAddLinkBtn" onclick="showLinkForm()" style="display: none;">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                                        <path d="M12 5v14M5 12h14"/>
                                    </svg>
                                    –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å
                                </button>
                            </div>
                        </div>
                        
                        <div id="taskLinksList">
                            <div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Common Footer for all tabs -->
                <div class="modal-footer" id="editTaskFooter">
                    <button type="button" class="btn btn-success" id="createSubtaskBtn" onclick="createSubtask()" style="display: none;" title="–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        –ü–æ–¥–∑–∞–¥–∞—á–∞
                    </button>
                    <button type="button" class="btn btn-secondary" id="linksMapBtn" onclick="openTaskLinksMap()" title="–ö–∞—Ä—Ç–∞ —Å–≤—è–∑–µ–π">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                        </svg>
                        –ö–∞—Ä—Ç–∞
                    </button>
                    <button type="button" class="btn btn-warning" id="archiveTaskBtn" onclick="toggleArchiveTask()" style="display: none;">–í –∞—Ä—Ö–∏–≤</button>
                    <button type="button" class="btn btn-danger" id="deleteTaskBtn" onclick="deleteCurrentTask()" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
                    <div style="flex: 1;"></div>
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="submit" class="btn btn-primary" id="saveTaskBtn" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Image Viewer Modal -->
    <div class="modal-overlay" id="imageViewerModal" style="background: rgba(0,0,0,0.95);">
        <div class="modal" style="max-width: 90vw; max-height: 90vh; background: transparent; border: none; box-shadow: none; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;">
            <button class="modal-close" onclick="closeModal('imageViewerModal')" style="position: absolute; top: -2.5rem; right: 0; background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
            <img id="imageViewerImg" src="" alt="" style="max-width: 85vw; max-height: 75vh; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); object-fit: contain;">
            <div id="imageViewerCaption" style="color: white; margin-top: 1rem; font-size: 0.95rem; text-align: center;"></div>
        </div>
    </div>
    
    <script src="/static/app.js?v=20260204"></script>
    <script>
        const projectId = window.location.pathname.split('/').pop();
        let kanbanData = [];
        let users = [];
        let project = null;
        let fieldGroups = [];
        let draggedTask = null;
        let currentTask = null;
        let userProjectPermission = 'read'; // 'read' or 'write' or null (admin). Start with 'read' to hide buttons by default
        let currentUser = null; // Current logged in user
        
        async function loadKanban() {
            const board = document.getElementById('kanbanBoard');
            
            try {
                kanbanData = await api.getKanbanData(projectId);
                
                // Get project info for title
                project = await api.getProject(projectId);
                fieldGroups = project.field_groups || [];
                document.getElementById('projectTitle').textContent = project.name;
                document.getElementById('projectLink').href = `/project/${projectId}`;
                document.getElementById('projectLink').textContent = project.name;
                document.getElementById('listLink').href = `/project/${projectId}`;
                document.getElementById('historyLink').href = `/history/${projectId}`;
                
                // Render custom fields for create form (will be hidden for regular users)
                renderCustomFields('Create');
                
                renderKanban();
            } catch (error) {
                board.innerHTML = `<div class="empty-state"><p>${error.message}</p></div>`;
            }
        }
        
        async function loadProjectPermissions() {
            try {
                const permissions = await api.getProjectPermissions(projectId);
                
                // Get current user's permission
                currentUser = await api.getCurrentUser();
                if (currentUser.is_admin) {
                    userProjectPermission = null; // Admins have write access (null means admin)
                } else {
                    const userPermission = permissions.find(p => p.user_id === currentUser.id);
                    userProjectPermission = userPermission ? userPermission.permission_type : 'read';
                }
                
                // Show author filter only if user is not regular user (user_type !== 'user')
                if (currentUser.user_type !== 'user' || currentUser.is_admin) {
                    const authorFilter = document.getElementById('authorFilter');
                    if (authorFilter) {
                        authorFilter.style.display = '';
                    }
                }
                
                // Show "–¢–æ–ª—å–∫–æ –º–æ–∏" checkbox for executors (developer)
                if (currentUser.user_type === 'developer' && !currentUser.is_admin) {
                    const onlyMineLabel = document.getElementById('onlyMineLabel');
                    const onlyMineCheckbox = document.getElementById('onlyMine');
                    if (onlyMineLabel) {
                        onlyMineLabel.style.display = 'flex';
                    }
                    // Restore saved state or enable by default for executors
                    if (onlyMineCheckbox) {
                        const savedState = localStorage.getItem(`onlyMine_${currentUser.id}`);
                        if (savedState !== null) {
                            onlyMineCheckbox.checked = savedState === 'true';
                        } else {
                            onlyMineCheckbox.checked = true; // Default: enabled for executors
                        }
                    }
                }
                
                // Show edit buttons if user has write access
                showEditButtonsIfAllowed();
            } catch (error) {
                console.error('Failed to load project permissions:', error);
            }
        }
        
        function showEditButtonsIfAllowed() {
            // Administrators always have full write access
            const isAdmin = currentUser && currentUser.is_admin;
            const hasWriteAccess = isAdmin || !userProjectPermission || userProjectPermission === 'write';
            
            // Show/hide "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" button based on write access
            const createTaskBtn = document.querySelector('button[onclick="openCreateTask()"]');
            if (createTaskBtn) {
                if (hasWriteAccess) {
                    createTaskBtn.style.removeProperty('display');
                } else {
                    createTaskBtn.style.setProperty('display', 'none', 'important');
                }
            }
            
            // Show/hide "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É" buttons in columns based on write access
            document.querySelectorAll('.column-add-task').forEach(btn => {
                const column = btn.closest('.kanban-column');
                const columnStageId = column ? parseInt(column.dataset.stageId) : null;
                if (hasWriteAccess) {
                    if (isAdmin || !currentUser || currentUser.user_type !== 'user') {
                        btn.style.removeProperty('display');
                    } else {
                        // Regular users: only allow button in first column
                        const firstColumn = document.querySelector('.kanban-column');
                        const firstStageId = firstColumn ? parseInt(firstColumn.dataset.stageId) : null;
                        if (firstStageId && columnStageId === firstStageId) {
                            btn.style.removeProperty('display');
                        } else {
                            btn.style.setProperty('display', 'none', 'important');
                        }
                    }
                } else {
                    btn.style.setProperty('display', 'none', 'important');
                }
            });
            
            // Show/hide "–í –∞—Ä—Ö–∏–≤" button on last column based on write access
            document.querySelectorAll('.column-archive-btn').forEach(btn => {
                btn.style.display = hasWriteAccess ? '' : 'none';
            });
            
            // Show/hide submit buttons in create task form based on write access
            const createTaskSubmit = document.getElementById('createTaskSubmitBtn');
            if (createTaskSubmit) {
                createTaskSubmit.style.display = hasWriteAccess ? '' : 'none';
            }
            
            // Show/hide submit button in edit task form based on write access
            const saveTaskBtn = document.getElementById('saveTaskBtn');
            if (saveTaskBtn) {
                saveTaskBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            
            // Show/hide archive and delete buttons in task modal based on write access
            const archiveBtn = document.getElementById('archiveTaskBtn');
            if (archiveBtn) {
                archiveBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            const deleteBtn = document.getElementById('deleteTaskBtn');
            if (deleteBtn) {
                deleteBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            const createSubtaskBtn = document.getElementById('createSubtaskBtn');
            if (createSubtaskBtn) {
                createSubtaskBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            
            // Show/hide comment input area based on write access
            const chatInputArea = document.querySelector('.chat-input-area');
            if (chatInputArea) {
                chatInputArea.style.display = hasWriteAccess ? '' : 'none';
            }
            
            // Show/hide attachment upload button based on write access
            const attachmentBtn = document.querySelector('button[onclick*="attachmentInput"]');
            if (attachmentBtn) {
                attachmentBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            
            // Enable form fields if write access
            if (hasWriteAccess) {
                const editTaskForm = document.getElementById('editTaskForm');
                if (editTaskForm) {
                    const inputs = editTaskForm.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (input.getAttribute('data-field-readonly') === 'true') {
                            input.disabled = true;
                            input.readOnly = true;
                            return;
                        }
                        input.disabled = false;
                        input.readOnly = false;
                    });
                }
                
                const createTaskForm = document.getElementById('createTaskForm');
                if (createTaskForm) {
                    const inputs = createTaskForm.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (input.getAttribute('data-field-readonly') === 'true') {
                            input.disabled = true;
                            input.readOnly = true;
                            return;
                        }
                        input.disabled = false;
                        input.readOnly = false;
                    });
                }
            } else {
                // Make form fields read-only if read-only permission
                const editTaskForm = document.getElementById('editTaskForm');
                if (editTaskForm) {
                    const inputs = editTaskForm.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.readOnly = true;
                    });
                }
                
                const createTaskForm = document.getElementById('createTaskForm');
                if (createTaskForm) {
                    const inputs = createTaskForm.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.readOnly = true;
                    });
                }
            }

            // Regular users cannot change stage in edit form
            if (currentUser && currentUser.user_type === 'user' && !currentUser.is_admin) {
                const editStage = document.getElementById('editTaskStage');
                if (editStage) {
                    editStage.disabled = true;
                }
            }
        }
        
        async function loadUsers() {
            try {
                users = await api.getUsers();
                const options = users.map(u => `<option value="${u.id}">${escapeHtml(u.full_name || u.username)}</option>`).join('');
                document.getElementById('taskAssignee').innerHTML = '<option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>' + options;
                document.getElementById('editTaskAssignee').innerHTML = '<option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>' + options;
                document.getElementById('authorFilter').innerHTML = '<option value="">–í—Å–µ –∞–≤—Ç–æ—Ä—ã</option>' + options;
                document.getElementById('assigneeFilter').innerHTML = '<option value="">–í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</option>' + options;
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }
        
        function onOnlyMineChange() {
            // Save state to localStorage
            const checkbox = document.getElementById('onlyMine');
            if (checkbox && currentUser) {
                localStorage.setItem(`onlyMine_${currentUser.id}`, checkbox.checked);
            }
            renderKanban(); // Re-render with new filter
        }
        
        function getFilteredTasks(tasks) {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const authorId = document.getElementById('authorFilter').value;
            const assigneeId = document.getElementById('assigneeFilter').value;
            const priority = document.getElementById('priorityFilter').value;
            const onlyMineCheckbox = document.getElementById('onlyMine');
            const onlyMine = onlyMineCheckbox && onlyMineCheckbox.checked;
            
            return tasks.filter(task => {
                // "–¢–æ–ª—å–∫–æ –º–æ–∏" filter - show only tasks where user is author or assignee
                if (onlyMine && currentUser) {
                    if (task.author_id !== currentUser.id && task.assignee_id !== currentUser.id) {
                        return false;
                    }
                }
                // Search filter
                if (searchValue && !task.title.toLowerCase().includes(searchValue) && 
                    !(task.description && task.description.toLowerCase().includes(searchValue))) {
                    return false;
                }
                // Author filter
                if (authorId && task.author_id != authorId) {
                    return false;
                }
                // Assignee filter
                if (assigneeId && task.assignee_id != assigneeId) {
                    return false;
                }
                // Priority filter
                if (priority !== '' && task.priority != priority) {
                    return false;
                }
                return true;
            });
        }
        
        function renderKanban() {
            const board = document.getElementById('kanbanBoard');
            
            // Sort by order
            const sortedColumns = [...kanbanData].sort((a, b) => a.order - b.order);
            const firstColumnId = sortedColumns.length > 0 ? sortedColumns[0].id : null;
            const lastColumnId = sortedColumns.length > 0 ? sortedColumns[sortedColumns.length - 1].id : null;
            const isRegularUser = currentUser && currentUser.user_type === 'user' && !currentUser.is_admin;
            
            board.innerHTML = sortedColumns.map(column => `
                <div class="kanban-column" data-stage-id="${column.id}" data-stage-order="${column.order}" draggable="true">
                    <div class="column-header">
                        <div class="column-title">
                            <span class="column-drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="6" r="1"/><circle cx="15" cy="6" r="1"/>
                                    <circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/>
                                    <circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/>
                                </svg>
                            </span>
                            <span class="column-indicator" style="background: ${column.color};"></span>
                            <span>${escapeHtml(column.name)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${column.id === lastColumnId ? `
                                <button class="column-archive-btn" onclick="archiveColumnTasks(${column.id})" style="display: none;" title="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏ –∏–∑ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–∏">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="21 8 21 21 3 21 3 8"/>
                                        <rect x="1" y="3" width="22" height="5"/>
                                        <line x1="10" y1="12" x2="14" y2="12"/>
                                    </svg>
                                </button>
                            ` : ''}
                            <span class="column-count">${getFilteredTasks(column.tasks).length}</span>
                        </div>
                    </div>
                    <button class="column-add-task" onclick="openCreateTask(${column.id})" style="display: none !important; ${isRegularUser && column.id !== firstColumnId ? 'display: none !important;' : ''}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                    <div class="column-tasks" data-stage-id="${column.id}">
                        ${getFilteredTasks(column.tasks).map(task => renderTaskCard(task)).join('')}
                    </div>
                </div>
            `).join('');
            
            // Ensure buttons are hidden until permissions are loaded
            showEditButtonsIfAllowed();
            
            // Setup drag and drop for tasks and columns
            setupDragAndDrop();
            setupColumnDragAndDrop();
        }
        
        function parseDateParts(dateStr) {
            if (!dateStr) return null;
            const text = String(dateStr);
            const match = text.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (!match) return null;
            const year = Number(match[1]);
            const month = Number(match[2]);
            const day = Number(match[3]);
            if (!year || !month || !day) return null;
            return { year, month, day };
        }
        
        function isOverdue(task) {
            const parts = parseDateParts(task.due_date);
            if (!parts) return false;
            const dueDay = new Date(parts.year, parts.month - 1, parts.day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return dueDay < today;
        }
        
        function formatDueDate(dateStr) {
            const parts = parseDateParts(dateStr);
            if (!parts) return '';
            const day = String(parts.day).padStart(2, '0');
            const month = String(parts.month).padStart(2, '0');
            return `${day}.${month}.${parts.year}`;
        }
        
        function renderTaskCard(task) {
            const isTaskOverdue = task.is_overdue === true || isOverdue(task);
            const canDragTasks = !(currentUser && currentUser.user_type === 'user' && !currentUser.is_admin);
            const overdueClass = isTaskOverdue ? ' task-overdue' : '';
            const overdueStyle = isTaskOverdue
                ? ' style="background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5);"'
                : '';
            return `
                <div class="kanban-task${overdueClass}"${overdueStyle}
                     data-task-id="${task.id}" 
                     draggable="${canDragTasks ? 'true' : 'false'}"
                     data-task-clickable="true">
                    <div class="kanban-task-header">
                        <span class="kanban-task-id">#${task.id}</span>
                        ${task.due_date ? `<span class="task-due-date${isTaskOverdue ? ' overdue' : ''}" title="–°—Ä–æ–∫: ${new Date(task.due_date).toLocaleDateString('ru-RU')}">${formatDueDate(task.due_date)}</span>` : ''}
                    </div>
                    <div class="kanban-task-title">${escapeHtml(task.title)}</div>
                    ${task.description ? `<div class="kanban-task-desc">${escapeHtml(task.description)}</div>` : ''}
                    <div class="kanban-task-footer">
                        <span class="priority-badge priority-${task.priority}">${getPriorityLabel(task.priority)}</span>
                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                            ${task.author ? `
                                <div class="task-assignee" title="–ê–≤—Ç–æ—Ä: ${escapeHtml(task.author.full_name || task.author.username)}">
                                    <div class="task-assignee-avatar">${getInitials(task.author.full_name || task.author.username)}</div>
                                </div>
                            ` : ''}
                            ${task.assignee ? `
                                <div class="task-assignee" title="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: ${escapeHtml(task.assignee.full_name || task.assignee.username)}">
                                    <div class="task-assignee-avatar">${getInitials(task.assignee.full_name || task.assignee.username)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        let allowedTargetStages = [];
        let draggedTaskStageId = null;
        let transitionsConfigured = false;
        
        function setupDragAndDrop() {
            const tasks = document.querySelectorAll('.kanban-task');
            const columns = document.querySelectorAll('.column-tasks');
            const canDragTasks = !(currentUser && currentUser.user_type === 'user' && !currentUser.is_admin);
            
            tasks.forEach(task => {
                if (canDragTasks) {
                    task.addEventListener('dragstart', handleDragStart);
                    task.addEventListener('dragend', handleDragEnd);
                }
                
                // Click handler for opening task (works on both desktop and mobile)
                let clickStartTime = 0;
                let clickStartX = 0;
                let clickStartY = 0;
                let hasMoved = false;
                
                task.addEventListener('mousedown', (e) => {
                    clickStartTime = Date.now();
                    clickStartX = e.clientX;
                    clickStartY = e.clientY;
                    hasMoved = false;
                });
                
                task.addEventListener('mousemove', (e) => {
                    if (clickStartTime) {
                        const deltaX = Math.abs(e.clientX - clickStartX);
                        const deltaY = Math.abs(e.clientY - clickStartY);
                        if (deltaX > 5 || deltaY > 5) {
                            hasMoved = true;
                        }
                    }
                });
                
                task.addEventListener('click', (e) => {
                    // Only open if it was a quick click without movement
                    if (!hasMoved && Date.now() - clickStartTime < 300) {
                        const taskId = parseInt(task.dataset.taskId);
                        openEditTask(taskId);
                    }
                    clickStartTime = 0;
                    hasMoved = false;
                });
                
                // Touch support for mobile
                task.addEventListener('touchstart', (e) => {
                    clickStartTime = Date.now();
                    clickStartX = e.touches[0].clientX;
                    clickStartY = e.touches[0].clientY;
                    hasMoved = false;
                }, { passive: true });
                
                task.addEventListener('touchmove', (e) => {
                    if (clickStartTime) {
                        const deltaX = Math.abs(e.touches[0].clientX - clickStartX);
                        const deltaY = Math.abs(e.touches[0].clientY - clickStartY);
                        if (deltaX > 10 || deltaY > 10) {
                            hasMoved = true;
                        }
                    }
                }, { passive: true });
                
                task.addEventListener('touchend', (e) => {
                    // Only open if it was a quick tap without movement
                    if (!hasMoved && Date.now() - clickStartTime < 300) {
                        e.preventDefault();
                        const taskId = parseInt(task.dataset.taskId);
                        openEditTask(taskId);
                    }
                    clickStartTime = 0;
                    hasMoved = false;
                });
            });
            
            if (canDragTasks) {
                columns.forEach(column => {
                    column.addEventListener('dragover', handleDragOver);
                    column.addEventListener('dragleave', handleDragLeave);
                    column.addEventListener('drop', handleDrop);
                });
            }
        }
        
        async function handleDragStart(e) {
            draggedTask = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
            
            // Find current stage of the task
            const taskId = e.target.dataset.taskId;
            const currentColumn = e.target.closest('.column-tasks');
            draggedTaskStageId = parseInt(currentColumn.dataset.stageId);
            
            // Load allowed transitions
            try {
                const response = await api.getAllowedTransitions(projectId, draggedTaskStageId);
                transitionsConfigured = response.configured;
                allowedTargetStages = response.stages.map(s => s.id);
                
                // Highlight allowed columns
                document.querySelectorAll('.kanban-column').forEach(col => {
                    const stageId = parseInt(col.dataset.stageId);
                    if (stageId === draggedTaskStageId) {
                        col.classList.add('drag-source');
                    } else if (allowedTargetStages.includes(stageId)) {
                        col.classList.add('drag-allowed');
                    } else if (transitionsConfigured) {
                        col.classList.add('drag-forbidden');
                    }
                });
            } catch (error) {
                console.error('Failed to load transitions:', error);
                allowedTargetStages = [];
                transitionsConfigured = false;
            }
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('drag-over', 'drag-source', 'drag-allowed', 'drag-forbidden');
            });
            document.querySelectorAll('.drop-placeholder').forEach(p => p.remove());
            draggedTask = null;
            draggedTaskStageId = null;
            allowedTargetStages = [];
        }
        
        function handleDragOver(e) {
            const column = e.currentTarget;
            const targetStageId = parseInt(column.dataset.stageId);
            
            // Check if drop is allowed
            const isAllowed = targetStageId === draggedTaskStageId || 
                              allowedTargetStages.includes(targetStageId) ||
                              !transitionsConfigured;
            
            if (!isAllowed) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            column.closest('.kanban-column').classList.add('drag-over');
            
            // Add placeholder
            const placeholder = column.querySelector('.drop-placeholder');
            if (!placeholder) {
                const div = document.createElement('div');
                div.className = 'drop-placeholder';
                
                // Find position for placeholder
                const afterElement = getDragAfterElement(column, e.clientY);
                if (afterElement) {
                    column.insertBefore(div, afterElement);
                } else {
                    column.appendChild(div);
                }
            } else {
                const afterElement = getDragAfterElement(column, e.clientY);
                if (afterElement) {
                    column.insertBefore(placeholder, afterElement);
                } else {
                    column.appendChild(placeholder);
                }
            }
        }
        
        function handleDragLeave(e) {
            // Only handle if leaving the column-tasks element entirely
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.closest('.kanban-column').classList.remove('drag-over');
                const placeholder = e.currentTarget.querySelector('.drop-placeholder');
                if (placeholder) placeholder.remove();
            }
        }
        
        async function handleDrop(e) {
            e.preventDefault();
            
            const column = e.currentTarget;
            const kanbanColumn = column.closest('.kanban-column');
            kanbanColumn.classList.remove('drag-over');
            
            const placeholder = column.querySelector('.drop-placeholder');
            if (placeholder) placeholder.remove();
            
            const taskId = e.dataTransfer.getData('text/plain');
            const targetStageId = parseInt(column.dataset.stageId);
            
            if (!taskId || !targetStageId) return;
            
            // Check if drop is allowed
            const isAllowed = targetStageId === draggedTaskStageId || 
                              allowedTargetStages.includes(targetStageId) ||
                              !transitionsConfigured;
            
            if (!isAllowed) {
                showAlert('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç—Ç–æ—Ç —ç—Ç–∞–ø –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω');
                return;
            }
            
            // Don't do anything if dropping on same stage
            if (targetStageId === draggedTaskStageId) {
                return;
            }
            
            try {
                await api.moveTask(taskId, targetStageId);
                loadKanban();
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.kanban-task:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        
        // Column drag and drop
        let draggedColumn = null;
        let columnDragAllowed = false;
        
        function setupColumnDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            const handles = document.querySelectorAll('.column-drag-handle');
            
            // Allow drag only when mousedown on handle
            handles.forEach(handle => {
                handle.addEventListener('mousedown', () => {
                    columnDragAllowed = true;
                });
            });
            
            document.addEventListener('mouseup', () => {
                columnDragAllowed = false;
            });
            
            columns.forEach(column => {
                column.addEventListener('dragstart', handleColumnDragStart);
                column.addEventListener('dragend', handleColumnDragEnd);
                column.addEventListener('dragover', handleColumnDragOver);
                column.addEventListener('dragleave', handleColumnDragLeave);
                column.addEventListener('drop', handleColumnDrop);
            });
        }
        
        function handleColumnDragStart(e) {
            const column = e.target.closest('.kanban-column');
            
            // If dragging a task, let task drag work
            if (e.target.classList.contains('kanban-task') || e.target.closest('.kanban-task')) {
                return;
            }
            
            // Only allow column drag if started from handle
            if (!columnDragAllowed) {
                e.preventDefault();
                return;
            }
            
            e.stopPropagation();
            draggedColumn = column;
            column.classList.add('column-dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('column-id', column.dataset.stageId);
        }
        
        function handleColumnDragEnd(e) {
            if (draggedColumn) {
                draggedColumn.classList.remove('column-dragging');
                draggedColumn = null;
            }
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('column-drag-over');
            });
        }
        
        function handleColumnDragOver(e) {
            if (!draggedColumn) return;
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const column = e.currentTarget;
            if (column !== draggedColumn) {
                column.classList.add('column-drag-over');
            }
        }
        
        function handleColumnDragLeave(e) {
            if (!draggedColumn) return;
            e.currentTarget.classList.remove('column-drag-over');
        }
        
        async function handleColumnDrop(e) {
            if (!draggedColumn) return;
            
            e.preventDefault();
            const targetColumn = e.currentTarget;
            targetColumn.classList.remove('column-drag-over');
            
            const draggedId = parseInt(draggedColumn.dataset.stageId);
            const targetId = parseInt(targetColumn.dataset.stageId);
            
            if (draggedId === targetId) return;
            
            // Reorder columns
            const columns = [...kanbanData].sort((a, b) => a.order - b.order);
            const draggedIndex = columns.findIndex(c => c.id === draggedId);
            const targetIndex = columns.findIndex(c => c.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // Move the dragged column
            const [draggedItem] = columns.splice(draggedIndex, 1);
            columns.splice(targetIndex, 0, draggedItem);
            
            // Create order updates - ensure int types
            const stageOrders = columns.map((c, i) => ({ id: parseInt(c.id), order: parseInt(i) }));
            
            try {
                await api.reorderStages(projectId, stageOrders);
                // Update local data
                columns.forEach((c, i) => {
                    const col = kanbanData.find(kd => kd.id === c.id);
                    if (col) col.order = i;
                });
                renderKanban();
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        async function openCreateTask(stageId = null) {
            // Get first stage if not provided - prefer initial stage, otherwise first by order
            if (stageId === null && kanbanData.length > 0) {
                const initialStage = kanbanData.find(col => col.is_initial);
                stageId = initialStage ? initialStage.id : kanbanData[0].id;
            }
            document.getElementById('taskStageId').value = stageId;
            
            // Check user type and hide fields for 'user' type
            try {
                const currentUser = await api.getCurrentUser();
                const assigneeGroup = document.getElementById('taskAssigneeGroup');
                const customFieldsContainer = document.getElementById('customFieldsCreate');
                
                if ((currentUser.user_type === 'user' || currentUser.user_type === 'developer') && !currentUser.is_admin) {
                    // Hide assignee field for regular users and executors
                    if (assigneeGroup) {
                        assigneeGroup.style.display = 'none';
                    }
                    // Hide custom fields for regular users and executors
                    if (customFieldsContainer) {
                        customFieldsContainer.style.display = 'none';
                    }
                } else {
                    // Show assignee field for other users
                    if (assigneeGroup) {
                        assigneeGroup.style.display = '';
                    }
                    // Show custom fields for other users
                    if (customFieldsContainer) {
                        customFieldsContainer.style.display = '';
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
            
            openModal('createTaskModal');
            // Hide edit buttons if read-only
            setTimeout(() => showEditButtonsIfAllowed(), 100);
        }
        
        function viewImage(attachmentId, filename) {
            const img = document.getElementById('imageViewerImg');
            const caption = document.getElementById('imageViewerCaption');
            
            // Show loading state
            caption.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            img.style.display = 'none';
            openModal('imageViewerModal');
            
            // Set up image load handlers
            img.onload = function() {
                img.style.display = 'block';
                caption.textContent = filename;
            };
            
            img.onerror = function() {
                caption.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + filename;
                img.style.display = 'none';
            };
            
            // Set image source
            img.src = api.getAttachmentViewUrl(attachmentId);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Create task form
        document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get first stage if not set (for regular users) - prefer initial stage, otherwise first by order
            let stageId = document.getElementById('taskStageId').value;
            if (!stageId && kanbanData.length > 0) {
                const initialStage = kanbanData.find(col => col.is_initial);
                stageId = initialStage ? initialStage.id : kanbanData[0].id;
            }
            
            // Get assignee only if field is visible
            let assigneeId = null;
            const assigneeGroup = document.getElementById('taskAssigneeGroup');
            if (assigneeGroup && assigneeGroup.style.display !== 'none') {
                assigneeId = document.getElementById('taskAssignee').value ? parseInt(document.getElementById('taskAssignee').value) : null;
            }
            
            // Get custom field values only if custom fields container is visible
            let fieldValues = [];
            const customFieldsContainer = document.getElementById('customFieldsCreate');
            if (customFieldsContainer && customFieldsContainer.style.display !== 'none') {
                fieldValues = getCustomFieldValues('createTaskForm');
            }
            
            const data = {
                project_id: parseInt(projectId),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value || null,
                stage_id: parseInt(stageId),
                assignee_id: assigneeId,
                priority: parseInt(document.getElementById('taskPriority').value),
                field_values: fieldValues
            };
            
            try {
                const newTask = await api.createTask(data);
                closeModal('createTaskModal');
                e.target.reset();
                
                // If there's pending link info, create the link
                if (window.pendingLinkInfo && newTask && newTask.id) {
                    let sourceId, targetId;
                    
                    // Handle both cases: creating linked task (sourceTaskId set) or subtask (targetTaskId set)
                    if (window.pendingLinkInfo.targetTaskId) {
                        // Subtask case: new task is child of existing task
                        sourceId = Number(newTask.id);
                        targetId = Number(window.pendingLinkInfo.targetTaskId);
                    } else {
                        // Linked task case: existing task links to new task
                        sourceId = Number(window.pendingLinkInfo.sourceTaskId);
                        targetId = Number(newTask.id);
                    }
                    
                    console.log('Link info:', { sourceId, targetId, pendingInfo: window.pendingLinkInfo });
                    
                    if (!isNaN(sourceId) && !isNaN(targetId) && sourceId > 0 && targetId > 0) {
                        try {
                            const linkData = {
                                source_task_id: sourceId,
                                target_task_id: targetId,
                                link_type: window.pendingLinkInfo.linkType || 'relates'
                            };
                            console.log('Creating link with data:', linkData);
                            await api.createTaskLink(linkData);
                            showAlert('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ —Å–≤—è–∑–∞–Ω–∞', 'success');
                        } catch (linkError) {
                            console.error('Link creation error:', linkError);
                            showAlert('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ —Å–≤—è–∑—å –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: ' + linkError.message);
                        }
                    } else {
                        console.error('Invalid IDs for link:', { sourceId, targetId });
                        showAlert('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ —Å–≤—è–∑—å –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: –Ω–µ–≤–µ—Ä–Ω—ã–µ ID');
                    }
                    window.pendingLinkInfo = null;
                }
                
                loadKanban();
            } catch (error) {
                showAlert(error.message);
            }
        });
        
        // Edit Task Functions
        let currentEditTaskId = null;
        let replyingToCommentId = null;
        let chatPollInterval = null;
        
        // Close task modal and stop polling
        function closeTaskModal() {
            if (chatPollInterval) {
                clearInterval(chatPollInterval);
                chatPollInterval = null;
            }
            currentEditTaskId = null;
            closeModal('editTaskModal');
        }
        
        // Start chat polling
        function startChatPolling(taskId) {
            if (chatPollInterval) {
                clearInterval(chatPollInterval);
            }
            
            chatPollInterval = setInterval(async () => {
                const chatTab = document.getElementById('taskTabChat');
                const modal = document.getElementById('editTaskModal');
                if (chatTab && chatTab.classList.contains('active') && modal && modal.classList.contains('active')) {
                    try {
                        const comments = await api.getTaskComments(taskId);
                        const container = document.getElementById('chatMessages');
                        const currentCount = container.querySelectorAll('.chat-message').length;
                        
                        if (comments.length !== currentCount) {
                            const badge = document.getElementById('chatBadge');
                            if (comments.length > 0) {
                                badge.textContent = comments.length;
                                badge.style.display = 'inline-flex';
                            } else {
                                badge.style.display = 'none';
                            }
                            
                            if (comments.length === 0) {
                                container.innerHTML = `
                                    <div class="chat-empty">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                        </svg>
                                        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                        <span>–ù–∞—á–Ω–∏—Ç–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏</span>
                                    </div>
                                `;
                            } else {
                                const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
                                container.innerHTML = comments.map(c => renderComment(c)).join('');
                                if (wasAtBottom) {
                                    container.scrollTop = container.scrollHeight;
                                }
                            }
                        }
                    } catch (error) {
                        console.log('Chat poll error:', error);
                    }
                }
            }, 1000);
        }
        
        function switchTaskTab(tabName) {
            document.querySelectorAll('.task-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            document.getElementById('taskTabMain').classList.toggle('active', tabName === 'main');
            document.getElementById('taskTabParams').classList.toggle('active', tabName === 'params');
            document.getElementById('taskTabExtra').classList.toggle('active', tabName === 'extra');
            document.getElementById('taskTabLinks').classList.toggle('active', tabName === 'links');
            document.getElementById('taskTabChat').classList.toggle('active', tabName === 'chat');
            document.getElementById('taskTabFiles').classList.toggle('active', tabName === 'files');
            document.getElementById('taskTabHistory').classList.toggle('active', tabName === 'history');
            
            if (tabName === 'history' && currentEditTaskId) loadTaskHistory(currentEditTaskId);
            if (tabName === 'chat' && currentEditTaskId) loadTaskComments(currentEditTaskId);
            if (tabName === 'files' && currentEditTaskId) loadTaskAttachments(currentEditTaskId);
            if (tabName === 'links' && currentEditTaskId) loadTaskLinks(currentEditTaskId);
        }
        
        function renderCustomFields(prefix = 'Create', taskData = null, fieldPermissions = {}) {
            const container = document.getElementById('customFields' + prefix);
            const fields = project?.field_definitions || [];
            
            // Show/hide "no fields" message for Edit form
            if (prefix === 'Edit') {
                const noFieldsMsg = document.getElementById('noCustomFields');
                if (noFieldsMsg) {
                    noFieldsMsg.style.display = fields.length === 0 ? 'block' : 'none';
                }
            }
            
            if (fields.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Group fields by group_id
            const groupedFields = {};
            fields.forEach(f => {
                const groupId = f.group_id || 'ungrouped';
                if (!groupedFields[groupId]) groupedFields[groupId] = [];
                groupedFields[groupId].push(f);
            });
            
            // Get group names
            const groupNames = {};
            const groupCollapsed = {};
            fieldGroups.forEach(g => {
                if (g.id) {
                    groupNames[g.id] = g.name;
                    groupCollapsed[g.id] = g.is_collapsed;
                }
            });
            
            let html = '';
            
            for (const [groupId, groupFields] of Object.entries(groupedFields)) {
                const isGroup = groupId !== 'ungrouped';
                const groupName = isGroup ? (groupNames[groupId] || '–ì—Ä—É–ø–ø–∞') : null;
                const collapsed = isGroup && groupCollapsed[groupId];
                
                if (isGroup) {
                    html += `
                        <div class="field-group" style="margin-top: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden;">
                            <div class="field-group-header" style="background: var(--bg-tertiary); padding: 0.75rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" 
                                 onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('svg').style.transform = this.nextElementSibling.classList.contains('hidden') ? 'rotate(-90deg)' : ''">
                                <span style="font-weight: 500;">${escapeHtml(groupName)}</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s; ${collapsed ? 'transform: rotate(-90deg);' : ''}">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <div class="field-group-content ${collapsed ? 'hidden' : ''}" style="padding: 1rem;">
                    `;
                }
                
                groupFields.forEach(field => {
                    const fieldValue = taskData?.field_values?.find(fv => fv.field_definition_id === field.id)?.value || '';
                    // –ü–æ–ª–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ fieldPermissions[field.id] === true
                    // –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –≤—Å–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã
                    const canEdit = prefix === 'Create' || fieldPermissions[field.id] === true;
                    const disabled = !canEdit ? 'disabled' : '';
                    const readonly = !canEdit ? 'readonly' : '';
                    const fieldReadonlyAttr = !canEdit ? 'data-field-readonly="true"' : '';
                    let input = '';
                    
                    switch (field.field_type) {
                        case 'text':
                            input = `<input type="text" class="form-input" name="field_${field.id}" value="${escapeHtml(fieldValue || '')}" ${disabled} ${readonly} ${fieldReadonlyAttr} style="${!canEdit ? 'background: var(--bg-tertiary); cursor: not-allowed;' : ''}">`;
                            break;
                        case 'number':
                            input = `<input type="number" class="form-input" name="field_${field.id}" value="${fieldValue || ''}" ${disabled} ${readonly} ${fieldReadonlyAttr} style="${!canEdit ? 'background: var(--bg-tertiary); cursor: not-allowed;' : ''}">`;
                            break;
                        case 'date':
                            input = `<input type="date" class="form-input" name="field_${field.id}" value="${fieldValue || ''}" ${disabled} ${fieldReadonlyAttr} style="${!canEdit ? 'background: var(--bg-tertiary); cursor: not-allowed;' : ''}">`;
                            break;
                        case 'checkbox':
                            input = `<input type="checkbox" name="field_${field.id}" ${fieldValue ? 'checked' : ''} ${disabled} ${fieldReadonlyAttr} style="width: 20px; height: 20px; ${!canEdit ? 'cursor: not-allowed; opacity: 0.6;' : ''}">`;
                            break;
                        case 'select':
                            const options = field.options?.options || [];
                            input = `<select class="form-select" name="field_${field.id}" ${disabled} ${fieldReadonlyAttr} style="${!canEdit ? 'background: var(--bg-tertiary); cursor: not-allowed;' : ''}">
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                                ${options.map(o => `<option value="${escapeHtml(o)}" ${fieldValue === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('')}
                            </select>`;
                            break;
                        default:
                            input = `<input type="text" class="form-input" name="field_${field.id}" value="${escapeHtml(fieldValue || '')}" ${disabled} ${readonly} ${fieldReadonlyAttr} style="${!canEdit ? 'background: var(--bg-tertiary); cursor: not-allowed;' : ''}">`;
                    }
                    
                    html += `
                        <div class="form-group">
                            <label class="form-label">
                                ${escapeHtml(field.name)}${field.is_required ? ' *' : ''}
                                ${!canEdit && prefix === 'Edit' ? '<span class="text-secondary" style="font-size: 0.75rem; margin-left: 0.5rem;">(—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä)</span>' : ''}
                            </label>
                            ${input}
                        </div>
                    `;
                });
                
                if (isGroup) {
                    html += `</div></div>`;
                }
            }
            
            container.innerHTML = html;
        }
        
        function getCustomFieldValues(formId) {
            const fields = project?.field_definitions || [];
            const values = [];
            
            fields.forEach(field => {
                const input = document.querySelector(`#${formId} [name="field_${field.id}"]`);
                if (input) {
                    let value;
                    if (input.type === 'checkbox') {
                        value = input.checked;
                    } else {
                        value = input.value;
                    }
                    if (value !== '' && value !== null) {
                        values.push({
                            field_definition_id: field.id,
                            value: value
                        });
                    }
                }
            });
            
            return values;
        }
        
        async function openEditTask(taskId) {
            try {
                currentEditTaskId = taskId;
                const task = await api.getTask(taskId);
                
                // Update modal title with task ID
                document.getElementById('editTaskIdLabel').textContent = '#' + task.id;
                
                // Load project if not loaded
                if (!project) {
                    project = await api.getProject(projectId);
                    fieldGroups = project.field_groups || [];
                }
                
                // Reset to main tab
                switchTaskTab('main');
                
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('editTaskTitle').value = task.title;
                document.getElementById('editTaskDescription').value = task.description || '';
                document.getElementById('editTaskAssignee').value = task.assignee_id || '';
                document.getElementById('editTaskPriority').value = task.priority;
                document.getElementById('editTaskDueDate').value = task.due_date ? task.due_date.split('T')[0] : '';
                
                // Display author and created date
                const authorName = task.author ? (task.author.full_name || task.author.username) : '‚Äî';
                document.getElementById('editTaskAuthor').textContent = authorName;
                document.getElementById('editTaskCreatedAt').textContent = formatDateTime(task.created_at);
                
                // Load field permissions for this task
                let fieldPermissions = {};
                try {
                    fieldPermissions = await api.checkFieldPermissions(taskId);
                } catch (error) {
                    console.error('Failed to load field permissions:', error);
                }
                
                // Update archive button text
                const archiveBtn = document.getElementById('archiveTaskBtn');
                archiveBtn.textContent = task.is_archived ? '–ò–∑ –∞—Ä—Ö–∏–≤–∞' : '–í –∞—Ä—Ö–∏–≤';
                
                // Load allowed transitions and populate stage select
                await populateEditStageSelect(task.stage_id);
                
                // Regular users cannot change stage
                try {
                    const currentUser = await api.getCurrentUser();
                    if (currentUser.user_type === 'user' && !currentUser.is_admin) {
                        const editStage = document.getElementById('editTaskStage');
                        if (editStage) {
                            editStage.disabled = true;
                        }
                    }
                } catch (error) {
                    console.error('Failed to check user type for stage edit:', error);
                }
                
                // Load attachments
                loadTaskAttachments(taskId);
                
                renderCustomFields('Edit', task, fieldPermissions);
                
                openModal('editTaskModal');
                
                // Show edit buttons if allowed (after loading comments and attachments)
                setTimeout(() => showEditButtonsIfAllowed(), 100);
                
                // Start polling for new chat messages
                startChatPolling(taskId);
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        async function populateEditStageSelect(currentStageId) {
            const select = document.getElementById('editTaskStage');
            const stages = project.stages || [];
            const currentStage = stages.find(s => s.id === currentStageId);
            
            try {
                // Get allowed transitions from current stage
                const response = await api.getAllowedTransitions(projectId, currentStageId);
                const allowedStages = response.stages;
                const transitionsConfigured = response.configured;
                
                // Build options: current stage + allowed transitions
                let options = `<option value="${currentStageId}">${escapeHtml(currentStage?.name || '–¢–µ–∫—É—â–∏–π')} (—Ç–µ–∫—É—â–∏–π)</option>`;
                
                if (transitionsConfigured) {
                    // Transitions are configured - only show allowed
                    if (allowedStages.length > 0) {
                        options += '<optgroup label="–†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã">';
                        options += allowedStages.map(s => 
                            `<option value="${s.id}">${escapeHtml(s.name)}${s.transition_name ? ` ‚Üí ${escapeHtml(s.transition_name)}` : ''}</option>`
                        ).join('');
                        options += '</optgroup>';
                    }
                } else {
                    // No transitions configured - show all stages
                    const otherStages = stages.filter(s => s.id !== currentStageId);
                    if (otherStages.length > 0) {
                        options += '<optgroup label="–î—Ä—É–≥–∏–µ —ç—Ç–∞–ø—ã">';
                        options += otherStages.map(s => 
                            `<option value="${s.id}">${escapeHtml(s.name)}</option>`
                        ).join('');
                        options += '</optgroup>';
                    }
                }
                
                select.innerHTML = options;
                select.value = currentStageId;
            } catch (error) {
                // Fallback to all stages
                select.innerHTML = stages.map(s => 
                    `<option value="${s.id}">${escapeHtml(s.name)}</option>`
                ).join('');
                select.value = currentStageId;
            }
        }
        
        async function toggleArchiveTask() {
            const taskId = document.getElementById('editTaskId').value;
            const task = await api.getTask(taskId);
            const newState = !task.is_archived;
            
            try {
                await api.updateTask(taskId, { is_archived: newState });
                closeTaskModal();
                loadKanban();
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        async function archiveColumnTasks(stageId) {
            // Find column data
            const column = kanbanData.find(c => c.id === stageId);
            if (!column) return;
            
            const tasksToArchive = getFilteredTasks(column.tasks).filter(t => !t.is_archived);
            if (tasksToArchive.length === 0) {
                showAlert('–í —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ –Ω–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
                return;
            }
            
            if (!confirm(`–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å ${tasksToArchive.length} –∑–∞–¥–∞—á –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ "${column.name}"?`)) {
                return;
            }
            
            try {
                let archived = 0;
                for (const task of tasksToArchive) {
                    await api.updateTask(task.id, { is_archived: true });
                    archived++;
                }
                showAlert(`–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞—á: ${archived}`, 'success');
                loadKanban();
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + error.message);
            }
        }
        
        async function deleteCurrentTask() {
            const taskId = document.getElementById('editTaskId').value;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
            
            try {
                await api.deleteTask(taskId);
                closeTaskModal();
                loadKanban();
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        // Chat functions
        async function loadTaskComments(taskId) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '<div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const comments = await api.getTaskComments(taskId);
                const badge = document.getElementById('chatBadge');
                badge.textContent = comments.length;
                badge.style.display = comments.length > 0 ? 'inline-flex' : 'none';
                
                if (comments.length === 0) {
                    container.innerHTML = '<div class="chat-empty"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p></div>';
                    return;
                }
                container.innerHTML = comments.map(c => renderComment(c)).join('');
                
                // Hide edit buttons if read-only
                showEditButtonsIfAllowed();
                
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                container.innerHTML = '<div class="text-center text-danger py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        function renderComment(c) {
            const date = new Date(c.created_at);
            const dateStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
            const initials = (c.user_full_name || c.user_name).split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
            const authorName = c.user_full_name || c.user_name;
            const replyHtml = c.reply_to_id && c.reply_to_text ? `<div class="chat-reply-quote" onclick="scrollToComment(${c.reply_to_id})"><div class="chat-reply-author">${escapeHtml(c.reply_to_author)}</div><div class="chat-reply-text">${escapeHtml(c.reply_to_text)}</div></div>` : '';
            const hasWriteAccess = !userProjectPermission || userProjectPermission === 'write';
            
            // Parse message for images
            const imageRegex = /\[image:(\d+):([^\]]+)\]/g;
            const messageText = c.message || '';
            let messageHtml = escapeHtml(messageText);
            let match;
            const images = [];
            
            while ((match = imageRegex.exec(messageText)) !== null) {
                const attachmentId = match[1];
                const fileName = match[2];
                const imageUrl = api.getAttachmentViewUrl(attachmentId);
                images.push({ id: attachmentId, url: imageUrl, name: fileName });
                messageHtml = messageHtml.replace(escapeHtml(match[0]), '');
            }
            
            messageHtml = messageHtml.trim().replace(/\n/g, '<br>');
            
            // Wrap emoji in span for larger display
            messageHtml = messageHtml.replace(/([\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{1FA00}-\u{1FAFF}]|[\u{231A}-\u{231B}]|[\u{23E9}-\u{23F3}]|[\u{23F8}-\u{23FA}]|[\u{25AA}-\u{25AB}]|[\u{25B6}]|[\u{25C0}]|[\u{25FB}-\u{25FE}]|[\u{2614}-\u{2615}]|[\u{2648}-\u{2653}]|[\u{267F}]|[\u{2693}]|[\u{26A1}]|[\u{26AA}-\u{26AB}]|[\u{26BD}-\u{26BE}]|[\u{26C4}-\u{26C5}]|[\u{26CE}]|[\u{26D4}]|[\u{26EA}]|[\u{26F2}-\u{26F3}]|[\u{26F5}]|[\u{26FA}]|[\u{26FD}]|[\u{2702}]|[\u{2705}]|[\u{2708}-\u{270D}]|[\u{270F}]|[\u{2712}]|[\u{2714}]|[\u{2716}]|[\u{271D}]|[\u{2721}]|[\u{2728}]|[\u{2733}-\u{2734}]|[\u{2744}]|[\u{2747}]|[\u{274C}]|[\u{274E}]|[\u{2753}-\u{2755}]|[\u{2757}]|[\u{2763}-\u{2764}]|[\u{2795}-\u{2797}]|[\u{27A1}]|[\u{27B0}]|[\u{27BF}]|[\u{2934}-\u{2935}]|[\u{2B05}-\u{2B07}]|[\u{2B1B}-\u{2B1C}]|[\u{2B50}]|[\u{2B55}]|[\u{3030}]|[\u{303D}]|[\u{3297}]|[\u{3299}]|[\u{FE0F}]|[\u{200D}])+/gu, '<span class="emoji-large">$&</span>');
            
            const imagesHtml = images.map(img => {
                const safeName = img.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `<img src="${img.url}" alt="${escapeHtml(img.name)}" class="chat-message-image" onclick="viewImage(${img.id}, '${safeName}')" loading="lazy">`;
            }).join('');
            
            return `
                <div class="chat-message ${c.is_own ? 'own' : ''}" id="comment-${c.id}">
                    <div class="chat-avatar ${c.is_own ? 'own' : ''}">${initials}</div>
                    <div class="chat-bubble">
                        <div class="chat-header"><span class="chat-author">${escapeHtml(authorName)}</span><span class="chat-time">${dateStr}</span>${c.is_edited ? '<span class="chat-edited">(–∏–∑–º.)</span>' : ''}</div>
                        ${replyHtml}
                        ${messageHtml ? `<div class="chat-text">${messageHtml}</div>` : ''}
                        ${imagesHtml}
                        <div class="chat-actions">
                            ${hasWriteAccess ? `
                            <button type="button" class="chat-action-btn" onclick="replyToComment(${c.id}, '${escapeHtml(authorName)}', ${JSON.stringify((c.message || '').substring(0,50)).replace(/"/g,'&quot;')})" title="–û—Ç–≤–µ—Ç–∏—Ç—å"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg></button>
                            ${c.is_own ? `<button type="button" class="chat-action-btn" onclick="editComment(${c.id}, ${JSON.stringify(c.message || '').replace(/"/g,'&quot;')})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button><button type="button" class="chat-action-btn" onclick="deleteComment(${c.id})" title="–£–¥–∞–ª–∏—Ç—å"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>` : ''}
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function replyToComment(commentId, authorName, preview) {
            replyingToCommentId = commentId;
            let indicator = document.getElementById('replyIndicator');
            if (!indicator) {
                const inputArea = document.querySelector('.chat-input-area');
                indicator = document.createElement('div');
                indicator.id = 'replyIndicator';
                indicator.className = 'reply-indicator';
                inputArea.parentNode.insertBefore(indicator, inputArea);
            }
            indicator.innerHTML = `<div class="reply-indicator-content"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg><span>–û—Ç–≤–µ—Ç –¥–ª—è <strong>${escapeHtml(authorName)}</strong></span></div><button type="button" class="reply-cancel" onclick="cancelReply()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
            indicator.style.display = 'flex';
            document.getElementById('chatInput').focus();
        }
        
        function cancelReply() {
            replyingToCommentId = null;
            const indicator = document.getElementById('replyIndicator');
            if (indicator) indicator.style.display = 'none';
        }
        
        function scrollToComment(id) {
            const el = document.getElementById(`comment-${id}`);
            if (el) { el.scrollIntoView({behavior:'smooth',block:'center'}); el.classList.add('highlight'); setTimeout(()=>el.classList.remove('highlight'),2000); }
        }
        
        // Emoji Picker
        const emojiCategories = {
            'recent': [],
            'smileys': ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'ü•≤', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'ü•∏', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', '‚ò†Ô∏è', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ'],
            'gestures': ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üíÖ', 'ü§≥', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 'üß†', 'ü´Ä', 'ü´Å', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ'],
            'hearts': ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù§Ô∏è‚Äçüî•', '‚ù§Ô∏è‚Äçü©π', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚ô•Ô∏è', 'üíå', 'üíã', 'üòª', 'üòΩ', 'üòò', 'ü•∞', 'üòç', 'ü§©', 'üòä', '‚ò∫Ô∏è'],
            'animals': ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üêª‚Äç‚ùÑÔ∏è', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'ü™±', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü™∞', 'ü™≤', 'ü™≥', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'üï∏Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä'],
            'food': ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'ü´ê', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'ü´ë', 'üåΩ', 'ü•ï', 'ü´í', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü´ì', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 'ü•ò', 'ü´ï', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'üç§', 'üçô', 'üçö', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üçæ'],
            'objects': ['‚åö', 'üì±', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìû', '‚òéÔ∏è', 'üì∫', 'üìª', 'üéôÔ∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üî´', 'üí£', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üîÆ', 'üíà', 'üî≠', 'üî¨', 'üíä', 'üíâ', 'ü©∏', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üöø', 'üõÅ', 'üßº', 'üîë', 'üóùÔ∏è', 'üö™', 'üõãÔ∏è', 'üõèÔ∏è', 'üß∏', 'üñºÔ∏è', 'üéÅ', 'üéà', 'üéè', 'üéÄ', '‚úâÔ∏è', 'üì©', 'üì®', 'üìß', 'üíå', 'üì¶', 'üìú', 'üìÉ', 'üìÑ', 'üìä', 'üìà', 'üìâ', 'üìã', 'üìÅ', 'üìÇ', 'üì∞', 'üìì', 'üìî', 'üìí', 'üìï', 'üìó', 'üìò', 'üìô', 'üìö', 'üìñ', 'üîó', 'üìé', '‚úÇÔ∏è', 'üìù', '‚úèÔ∏è', 'üîç', 'üîé', 'üîí', 'üîì'],
            'symbols': ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', '‚ößÔ∏è', 'üöª', 'üöÆ', 'üé¶', 'üì∂', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', '#Ô∏è‚É£', '*Ô∏è‚É£', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üéµ', 'üé∂', '‚ûï', '‚ûñ', '‚ûó', '‚úñÔ∏è', '‚ôæÔ∏è', 'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∫', 'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', 'üîà', 'üîá', 'üîâ', 'üîä', 'üîî', 'üîï', 'üì£', 'üì¢', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', 'üÉè', 'üé¥']
        };
        
        const categoryNames = {
            'recent': 'üïê –ù–µ–¥–∞–≤–Ω–∏–µ',
            'smileys': 'üòÄ –°–º–∞–π–ª–∏–∫–∏',
            'gestures': 'üëã –ñ–µ—Å—Ç—ã',
            'hearts': '‚ù§Ô∏è –°–µ—Ä–¥–µ—á–∫–∏',
            'animals': 'üê± –ñ–∏–≤–æ—Ç–Ω—ã–µ',
            'food': 'üçî –ï–¥–∞',
            'objects': 'üí° –û–±—ä–µ–∫—Ç—ã',
            'symbols': '‚úÖ –°–∏–º–≤–æ–ª—ã'
        };
        
        let currentEmojiCategory = 'smileys';
        
        function loadRecentEmojis() {
            try {
                const saved = localStorage.getItem('recentEmojis');
                if (saved) emojiCategories.recent = JSON.parse(saved).slice(0, 32);
            } catch (e) {}
        }
        
        function saveRecentEmoji(emoji) {
            try {
                let recent = emojiCategories.recent.filter(e => e !== emoji);
                recent.unshift(emoji);
                recent = recent.slice(0, 32);
                emojiCategories.recent = recent;
                localStorage.setItem('recentEmojis', JSON.stringify(recent));
            } catch (e) {}
        }
        
        function toggleEmojiPicker(event) {
            if (event) event.stopPropagation();
            const picker = document.getElementById('emojiPicker');
            if (picker.style.display === 'none') {
                loadRecentEmojis();
                if (emojiCategories.recent.length > 0) currentEmojiCategory = 'recent';
                renderEmojiPicker();
                picker.style.display = 'block';
            } else {
                picker.style.display = 'none';
            }
        }
        
        function renderEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const categories = Object.keys(emojiCategories).filter(cat => cat !== 'recent' || emojiCategories.recent.length > 0);
            
            picker.innerHTML = `
                <div class="emoji-picker-header">
                    ${categories.map(cat => `
                        <button type="button" class="emoji-category-btn ${cat === currentEmojiCategory ? 'active' : ''}" 
                                onclick="event.stopPropagation(); switchEmojiCategory('${cat}')" title="${categoryNames[cat]}">${categoryNames[cat].split(' ')[0]}</button>
                    `).join('')}
                </div>
                <div class="emoji-picker-title">${categoryNames[currentEmojiCategory]}</div>
                <div class="emoji-grid">
                    ${emojiCategories[currentEmojiCategory].map(emoji => `
                        <button type="button" class="emoji-btn" onclick="event.stopPropagation(); insertEmoji('${emoji}')">${emoji}</button>
                    `).join('')}
                </div>
            `;
        }
        
        function switchEmojiCategory(category) {
            currentEmojiCategory = category;
            renderEmojiPicker();
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('chatInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.selectionStart = input.selectionEnd = start + emoji.length;
            input.focus();
            saveRecentEmoji(emoji);
        }
        
        async function uploadChatImage(fileInput) {
            const file = fileInput.files[0];
            if (!file || !currentEditTaskId) return;
            
            if (!file.type.startsWith('image/')) {
                showAlert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                showAlert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è 10 –ú–ë');
                return;
            }
            
            try {
                const attachment = await api.uploadAttachment(currentEditTaskId, file);
                const message = `[image:${attachment.id}:${file.name}]`;
                await api.createComment(currentEditTaskId, message, replyingToCommentId);
                cancelReply();
                await loadTaskComments(currentEditTaskId);
            } catch (error) {
                showAlert(error.message);
            }
            
            fileInput.value = '';
        }
        
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('emojiPicker');
            const emojiBtn = e.target.closest('.chat-action-btn');
            if (picker && picker.style.display !== 'none' && !picker.contains(e.target) && !emojiBtn) {
                picker.style.display = 'none';
            }
        });
        
        async function sendComment() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || !currentEditTaskId) return;
            try {
                input.disabled = true;
                await api.createComment(currentEditTaskId, message, replyingToCommentId);
                input.value = '';
                cancelReply();
                await loadTaskComments(currentEditTaskId);
            } catch (error) {
                showAlert(error.message);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }
        
        async function editComment(commentId, currentMessage) {
            const newMessage = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:', currentMessage);
            if (!newMessage || newMessage === currentMessage) return;
            try {
                await api.updateComment(currentEditTaskId, commentId, newMessage.trim());
                await loadTaskComments(currentEditTaskId);
            } catch (error) { showAlert(error.message); }
        }
        
        async function deleteComment(commentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
            try {
                await api.deleteComment(currentEditTaskId, commentId);
                await loadTaskComments(currentEditTaskId);
            } catch (error) { showAlert(error.message); }
        }
        
        // History functions
        async function loadTaskHistory(taskId) {
            const container = document.getElementById('taskHistoryList');
            container.innerHTML = '<div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>';
            
            try {
                const history = await api.getTaskHistory(taskId);
                
                if (history.length === 0) {
                    container.innerHTML = `
                        <div class="history-empty">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <p>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = history.map(h => {
                    const date = new Date(h.created_at);
                    const formattedDate = date.toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                    const formattedTime = date.toLocaleTimeString('ru-RU', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const iconClass = h.action;
                    let icon = '';
                    switch(h.action) {
                        case 'created':
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>';
                            break;
                        case 'stage_changed':
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
                            break;
                        case 'attachment_added':
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>';
                            break;
                        case 'attachment_deleted':
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>';
                            break;
                        case 'comment_added':
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>';
                            break;
                        default:
                            icon = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>';
                    }
                    
                    return `
                        <div class="history-item">
                            <div class="history-icon ${iconClass}">
                                ${icon}
                            </div>
                            <div class="history-content">
                                <div class="history-description">${escapeHtml(h.description)}</div>
                                <div class="history-meta">
                                    <span>${escapeHtml(h.user_full_name || h.user_name)}</span>
                                    <span>${formattedDate} ${formattedTime}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div class="text-center text-danger py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        // Task Links functions
        const LINK_TYPE_NAMES = {
            'blocks': '–ë–ª–æ–∫–∏—Ä—É–µ—Ç',
            'blocked_by': '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞',
            'relates': '–°–≤—è–∑–∞–Ω–∞ —Å',
            'duplicates': '–î—É–±–ª–∏—Ä—É–µ—Ç',
            'duplicated_by': '–î—É–±–ª–∏—Ä—É–µ—Ç—Å—è',
            'parent': '–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –¥–ª—è',
            'child': '–î–æ—á–µ—Ä–Ω—è—è –æ—Ç'
        };
        
        let selectedLinkTaskId = null;
        
        async function loadTaskLinks(taskId) {
            const container = document.getElementById('taskLinksList');
            container.innerHTML = '<div class="text-center text-secondary py-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π...</div>';
            
            // Show add button if user has write access
            const hasWriteAccess = !userProjectPermission || userProjectPermission === 'write';
            const addLinkBtn = document.getElementById('showAddLinkBtn');
            if (addLinkBtn) {
                addLinkBtn.style.display = hasWriteAccess ? '' : 'none';
            }
            
            try {
                const links = await api.getTaskLinks(taskId);
                const allLinks = [...links.outgoing, ...links.incoming];
                
                // Update badge
                const badge = document.getElementById('linksBadge');
                if (allLinks.length > 0) {
                    badge.textContent = allLinks.length;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
                
                if (allLinks.length === 0) {
                    container.innerHTML = `
                        <div class="links-empty" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 1rem; opacity: 0.5;">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                            <p style="margin: 0;">–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = allLinks.map(link => {
                    const task = link.linked_task;
                    const typeName = LINK_TYPE_NAMES[link.link_type] || link.link_type;
                    
                    const priorityLabels = ['–ù–∏–∑–∫–∏–π', '–û–±—ã—á–Ω—ã–π', '–í—ã—Å–æ–∫–∏–π', '–ö—Ä–∏—Ç–∏—á–Ω—ã–π'];
                    const priorityColors = ['#6b7280', '#3b82f6', '#f59e0b', '#ef4444'];
                    
                    return `
                        <div class="link-item" style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 0.5rem;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <span class="link-type-badge" style="font-size: 0.75rem; padding: 0.125rem 0.5rem; background: var(--accent-primary); color: white; border-radius: 4px;">${typeName}</span>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">#${task.id}</span>
                                </div>
                                <a href="javascript:void(0)" onclick="openLinkedTask(${task.id}, ${task.project_id})" style="color: var(--text-primary); text-decoration: none; font-weight: 500; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${escapeHtml(task.title)}
                                </a>
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-secondary);">
                                    <span style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="width: 8px; height: 8px; border-radius: 50%; background: ${task.stage_color || '#6366f1'};"></span>
                                        ${escapeHtml(task.stage_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}
                                    </span>
                                    <span style="color: ${priorityColors[task.priority]};">${priorityLabels[task.priority]}</span>
                                    ${task.is_archived ? '<span style="color: var(--danger);">–í –∞—Ä—Ö–∏–≤–µ</span>' : ''}
                                </div>
                            </div>
                            ${hasWriteAccess ? `
                                <button type="button" class="btn-icon" onclick="deleteTaskLink(${link.id})" title="–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å" style="color: var(--danger); opacity: 0.7;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 6L6 18M6 6l12 12"/>
                                    </svg>
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-center text-danger py-4">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
            }
        }
        
        function openLinkedTask(taskId, taskProjectId) {
            if (taskProjectId == projectId) {
                // Same project - just open the task
                closeTaskModal();
                setTimeout(() => openEditTask(taskId), 300);
            } else {
                // Different project - navigate to it
                window.location.href = `/kanban/${taskProjectId}?task=${taskId}`;
            }
        }
        
        function showLinkForm() {
            document.getElementById('addLinkForm').style.display = 'block';
            document.getElementById('showAddLinkBtn').style.display = 'none';
            document.getElementById('linkTaskSearch').value = '';
            document.getElementById('linkTaskResults').innerHTML = '';
            selectedLinkTaskId = null;
        }
        
        function hideLinkForm() {
            document.getElementById('addLinkForm').style.display = 'none';
            const hasWriteAccess = !userProjectPermission || userProjectPermission === 'write';
            document.getElementById('showAddLinkBtn').style.display = hasWriteAccess ? '' : 'none';
            selectedLinkTaskId = null;
        }
        
        // Search tasks for linking
        let linkSearchTimeout = null;
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('linkTaskSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    clearTimeout(linkSearchTimeout);
                    linkSearchTimeout = setTimeout(() => searchTasksForLink(this.value), 300);
                });
            }
        });
        
        async function searchTasksForLink(query) {
            const container = document.getElementById('linkTaskResults');
            if (!query || query.length < 2) {
                container.innerHTML = '';
                return;
            }
            
            try {
                // Search by ID if query starts with #
                let tasks;
                if (query.startsWith('#')) {
                    const taskId = parseInt(query.slice(1));
                    if (taskId) {
                        const task = await api.getTask(taskId);
                        tasks = task ? [task] : [];
                    } else {
                        tasks = [];
                    }
                } else {
                    // Search by title in current project
                    tasks = await api.getTasks(projectId, { search: query, limit: 10 });
                }
                
                // Filter out current task
                tasks = tasks.filter(t => t.id !== currentEditTaskId);
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="text-secondary" style="padding: 0.5rem;">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="link-search-result ${selectedLinkTaskId === task.id ? 'selected' : ''}" 
                         onclick="selectTaskForLink(${task.id}, '${escapeHtml(task.title).replace(/'/g, "\\'")}', ${task.project_id})"
                         style="padding: 0.5rem; cursor: pointer; border-radius: var(--radius-sm); ${selectedLinkTaskId === task.id ? 'background: var(--accent-primary); color: white;' : ''}"
                         onmouseover="this.style.background = this.classList.contains('selected') ? 'var(--accent-primary)' : 'var(--bg-secondary)'"
                         onmouseout="this.style.background = this.classList.contains('selected') ? 'var(--accent-primary)' : ''">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: ${selectedLinkTaskId === task.id ? 'rgba(255,255,255,0.7)' : 'var(--text-secondary)'}; font-size: 0.85rem;">#${task.id}</span>
                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(task.title)}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = `<div class="text-danger" style="padding: 0.5rem;">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        function selectTaskForLink(taskId, taskTitle, taskProjectId) {
            selectedLinkTaskId = taskId;
            document.getElementById('linkTaskSearch').value = `#${taskId} ${taskTitle}`;
            document.getElementById('linkTaskResults').innerHTML = '';
        }
        
        async function addTaskLink() {
            if (!selectedLinkTaskId) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è');
                return;
            }
            
            const linkType = document.getElementById('linkType').value;
            
            try {
                await api.createTaskLink({
                    source_task_id: currentEditTaskId,
                    target_task_id: selectedLinkTaskId,
                    link_type: linkType
                });
                
                hideLinkForm();
                loadTaskLinks(currentEditTaskId);
                showAlert('–°–≤—è–∑—å –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        async function deleteTaskLink(linkId) {
            try {
                await api.deleteTaskLink(linkId);
                loadTaskLinks(currentEditTaskId);
                showAlert('–°–≤—è–∑—å —É–¥–∞–ª–µ–Ω–∞', 'success');
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        async function createLinkedTask() {
            // Get link type for the new task
            const linkType = document.getElementById('linkType').value;
            
            // Store source task ID as integer before closing modal
            const sourceId = parseInt(currentEditTaskId);
            if (!sourceId || isNaN(sourceId)) {
                showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏');
                return;
            }
            
            // Close current task modal
            closeTaskModal();
            
            // Store link info for after task creation
            window.pendingLinkInfo = {
                sourceTaskId: sourceId,
                linkType: linkType
            };
            
            // Open create task modal
            setTimeout(() => {
                openCreateTask();
            }, 300);
        }
        
        function openTaskLinksMap() {
            // Open links map for current task
            window.location.href = `/links/${currentEditTaskId}?from=kanban`;
        }
        
        function createSubtask() {
            // Store parent task info for linking after creation
            const parentTaskId = currentEditTaskId;
            window.pendingLinkInfo = {
                sourceTaskId: null, // Will be set to new task ID
                targetTaskId: parseInt(parentTaskId),
                linkType: 'child'
            };
            
            // Close edit modal and open create modal
            closeTaskModal();
            setTimeout(() => {
                openCreateTask();
            }, 300);
        }
        
        // Files functions
        async function loadTaskAttachments(taskId) {
            const container = document.getElementById('taskAttachments');
            container.innerHTML = '<div class="text-secondary">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            try {
                const attachments = await api.getTaskAttachments(taskId);
                const badge = document.getElementById('filesBadge');
                badge.textContent = attachments.length;
                badge.style.display = attachments.length > 0 ? 'inline-flex' : 'none';
                
                if (attachments.length === 0) {
                    container.innerHTML = '<div class="text-center py-4" style="grid-column:1/-1;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin:0 auto 1rem;opacity:0.3;"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg><p class="text-secondary">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</p></div>';
                    return;
                }
                container.innerHTML = attachments.map(att => `
                    <div class="file-card">
                        <div class="file-preview">${att.is_image ? `<img src="${api.getAttachmentViewUrl(att.id)}" onclick="viewImage(${att.id}, '${escapeHtml(att.filename)}')">` : '<div class="file-preview-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg></div>'}</div>
                        <div class="file-info"><div class="file-name" title="${escapeHtml(att.filename)}">${escapeHtml(att.filename)}</div><div class="file-meta">${formatFileSize(att.file_size)}</div></div>
                        <div class="file-actions">${att.is_image ? `<button type="button" class="btn btn-secondary btn-sm" onclick="viewImage(${att.id}, '${escapeHtml(att.filename)}')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>` : ''}<a href="${api.getAttachmentDownloadUrl(att.id)}" class="btn btn-secondary btn-sm" target="_blank"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></a>${(!userProjectPermission || userProjectPermission === 'write') ? `<button type="button" class="btn btn-ghost btn-sm" onclick="deleteAttachment(${att.id})" style="color:var(--danger);"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>` : ''}</div>
                    </div>
                `).join('');
                
                // Hide edit buttons if read-only
                showEditButtonsIfAllowed();
            } catch (error) {
                container.innerHTML = '<div class="text-secondary">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        async function deleteAttachment(attachmentId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) return;
            try {
                await api.deleteAttachment(attachmentId);
                if (currentEditTaskId) loadTaskAttachments(currentEditTaskId);
            } catch (error) { showAlert(error.message); }
        }
        
        // File upload handler
        document.getElementById('attachmentInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length || !currentEditTaskId) return;
            const progress = document.getElementById('uploadProgress');
            for (let i = 0; i < files.length; i++) {
                progress.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ ${i+1}/${files.length}...`;
                try { await api.uploadAttachment(currentEditTaskId, files[i]); } catch (error) { showAlert(error.message); }
            }
            progress.textContent = '';
            e.target.value = '';
            loadTaskAttachments(currentEditTaskId);
        });
        
        // Chat input handlers
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px'; });
        chatInput.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendComment(); } });
        
        document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const data = {
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value || null,
                stage_id: parseInt(document.getElementById('editTaskStage').value),
                assignee_id: document.getElementById('editTaskAssignee').value ? parseInt(document.getElementById('editTaskAssignee').value) : null,
                priority: parseInt(document.getElementById('editTaskPriority').value),
                due_date: document.getElementById('editTaskDueDate').value || null,
                field_values: getCustomFieldValues('editTaskForm')
            };
            
            try {
                await api.updateTask(taskId, data);
                closeTaskModal();
                loadKanban();
            } catch (error) {
                showAlert(error.message);
            }
        });
        
        // Filter event handlers
        ['authorFilter', 'assigneeFilter', 'priorityFilter'].forEach(id => {
            document.getElementById(id).addEventListener('change', renderKanban);
        });
        
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(renderKanban, 300);
        });
        
        // Show users link for admins
        async function initNav() {
            try {
                const user = await api.getCurrentUser();
                if (user.is_admin) {
                    const usersLink = document.getElementById('usersNavLink');
                    if (usersLink) usersLink.style.display = '';
                    const settingsLink = document.getElementById('settingsNavLink');
                    if (settingsLink) settingsLink.style.display = '';
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }
        
        // Override openModal to hide buttons for read-only users
        const originalOpenModal = window.openModal;
        window.openModal = function(modalId) {
            originalOpenModal(modalId);
            if (modalId === 'createTaskModal' || modalId === 'editTaskModal') {
                setTimeout(() => showEditButtonsIfAllowed(), 100);
            }
        };
        
        // Auto-refresh kanban every 10 seconds (if no modal is open and no drag in progress)
        let autoRefreshInterval = null;
        let isDragging = false;
        
        function startAutoRefresh() {
            if (autoRefreshInterval) return;
            autoRefreshInterval = setInterval(() => {
                // Don't refresh if modal is open or drag is in progress
                const activeModal = document.querySelector('.modal-overlay.active');
                if (!activeModal && !isDragging) {
                    loadKanban();
                }
            }, 10000); // 10 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        // Track drag state
        document.addEventListener('dragstart', () => { isDragging = true; });
        document.addEventListener('dragend', () => { isDragging = false; });
        
        // Initialize
        initNav();
        Promise.all([loadProjectPermissions(), loadUsers()]).then(async () => {
            await loadKanban(); // Load kanban after permissions (for "–¢–æ–ª—å–∫–æ –º–æ–∏" filter)
            // Start auto-refresh
            startAutoRefresh();
        });
        
        // Stop refresh when page is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                startAutoRefresh();
            }
        });
    </script>
</body>
</html>

