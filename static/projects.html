<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Проекты - Lifeline</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/projects" class="navbar-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span class="gradient-text">Lifeline</span>
            </a>
            <div class="navbar-nav">
                <a href="/projects" class="nav-link active">Проекты</a>
                <a href="/users" class="nav-link" id="usersNavLink" style="display: none;">Пользователи</a>
                <a href="/settings" class="nav-link" id="settingsNavLink" style="display: none;">Настройки</a>
            </div>
            <div class="user-menu"></div>
        </div>
    </nav>
    
    <main class="container">
        <div class="projects-header">
            <div>
                <h1>Мои проекты</h1>
                <label class="archive-toggle">
                    <input type="checkbox" id="showArchivedToggle" onchange="toggleShowArchived()">
                    Показать архив
                </label>
            </div>
            <button class="btn btn-primary" onclick="openModal('createProjectModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Новый проект
            </button>
        </div>
        
        <div id="projectsGrid" class="projects-grid">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    </main>
    
    <!-- Create Project Modal -->
    <div class="modal-overlay" id="createProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Создать проект</h3>
                <button class="modal-close" onclick="closeModal('createProjectModal')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="createProjectForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" for="projectName">Название проекта</label>
                        <input type="text" id="projectName" class="form-input" placeholder="Введите название" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="projectDescription">Описание</label>
                        <textarea id="projectDescription" class="form-textarea" placeholder="Описание проекта"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createProjectModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        let projects = [];
        let isAdminUser = false;
        let showArchived = false;
        
        async function loadProjects() {
            const grid = document.getElementById('projectsGrid');
            
            try {
                projects = await api.getProjects(showArchived);
                renderProjects();
            } catch (error) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <h3>Ошибка загрузки</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function renderProjects() {
            const grid = document.getElementById('projectsGrid');
            
            if (projects.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                        </svg>
                        <h3>Нет проектов</h3>
                        <p>Создайте свой первый проект</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = projects.map(project => `
                <div class="project-card ${project.is_archived ? 'archived' : ''}" onclick="window.location.href='/project/${project.id}'">
                    ${project.is_archived ? '<span class="project-archived-badge">Архив</span>' : ''}
                    <h3 class="project-name">${escapeHtml(project.name)}</h3>
                    <p class="project-description">${escapeHtml(project.description || 'Без описания')}</p>
                    <div class="project-meta">
                        <span>${project.stages?.length || 0} этапов</span>
                    </div>
                    ${isAdminUser ? `
                        <div class="project-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-secondary btn-sm" onclick="toggleProjectArchive(${project.id})">
                                ${project.is_archived ? 'Из архива' : 'В архив'}
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProject(${project.id})">
                                Удалить
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDescription').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Создание...';
            
            try {
                await api.createProject({ name, description });
                closeModal('createProjectModal');
                e.target.reset();
                loadProjects();
            } catch (error) {
                showAlert(error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Создать';
            }
        });
        
        // Show users link for admins
        async function initNav() {
            try {
                const user = await api.getCurrentUser();
                isAdminUser = user.is_admin;
                if (isAdminUser) {
                    const usersLink = document.getElementById('usersNavLink');
                    if (usersLink) usersLink.style.display = '';
                    const settingsLink = document.getElementById('settingsNavLink');
                    if (settingsLink) settingsLink.style.display = '';
                } else {
                    // Hide "Новый проект" button for non-admins
                    const createProjectBtn = document.querySelector('button[onclick*="createProjectModal"]');
                    if (createProjectBtn) {
                        createProjectBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        function toggleShowArchived() {
            showArchived = document.getElementById('showArchivedToggle').checked;
            loadProjects();
        }

        async function toggleProjectArchive(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            const newState = !project.is_archived;
            const message = newState
                ? 'Переместить проект в архив?'
                : 'Восстановить проект из архива?';
            if (!confirm(message)) return;
            try {
                await api.updateProject(projectId, { is_archived: newState });
                loadProjects();
            } catch (error) {
                showAlert(error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Удалить проект и все содержимое без возможности восстановления?')) return;
            try {
                await api.deleteProject(projectId);
                loadProjects();
                showAlert('Проект удалён', 'success');
            } catch (error) {
                showAlert(error.message);
            }
        }
        
        // Initialize
        initNav();
        loadProjects();
    </script>
</body>
</html>

