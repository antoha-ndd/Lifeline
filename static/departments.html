<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подразделения - Lifeline</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/projects" class="navbar-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span class="gradient-text">Lifeline</span>
            </a>
            <div class="navbar-nav">
                <a href="/projects" class="nav-link">Проекты</a>
                <a href="/users" class="nav-link">Пользователи</a>
                <a href="/organizations" class="nav-link">Организации</a>
                <a href="/departments" class="nav-link active">Подразделения</a>
                <a href="/settings" class="nav-link" id="settingsNavLink" style="display: none;">Настройки</a>
            </div>
            <div class="user-menu"></div>
        </div>
    </nav>
    
    <main class="container">
        <div class="projects-header">
            <h1>Подразделения</h1>
            <button class="btn btn-primary" onclick="openModal('createDeptModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Новое подразделение
            </button>
        </div>
        
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Организация</th>
                        <th>Описание</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="departmentsTableBody">
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="loading"><div class="spinner"></div></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>
    
    <!-- Create Department Modal -->
    <div class="modal-overlay" id="createDeptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Создать подразделение</h3>
                <button class="modal-close" onclick="closeModal('createDeptModal')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="createDeptForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" for="createDeptName">Название *</label>
                        <input type="text" id="createDeptName" class="form-input" placeholder="Название подразделения" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="createDeptOrganization">Организация *</label>
                        <select id="createDeptOrganization" class="form-select" required>
                            <option value="">-- Выберите организацию --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="createDeptDescription">Описание</label>
                        <textarea id="createDeptDescription" class="form-textarea" placeholder="Описание подразделения"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createDeptModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Создать</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Department Modal -->
    <div class="modal-overlay" id="editDeptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Редактировать подразделение</h3>
                <button class="modal-close" onclick="closeModal('editDeptModal')">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="editDeptForm">
                <input type="hidden" id="editDeptId">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" for="editDeptName">Название *</label>
                        <input type="text" id="editDeptName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editDeptOrganization">Организация *</label>
                        <select id="editDeptOrganization" class="form-select" required>
                            <option value="">-- Выберите организацию --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editDeptDescription">Описание</label>
                        <textarea id="editDeptDescription" class="form-textarea"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editDeptModal')">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        let departments = [];
        let organizations = [];
        let currentUser = null;
        
        async function init() {
            currentUser = await api.getCurrentUser();
            if (!currentUser.is_admin) {
                window.location.href = '/projects';
                return;
            }
            setupUserMenu();
            await loadOrganizations();
            loadDepartments();
        }
        
        function setupUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu && currentUser) {
                userMenu.innerHTML = `
                    <a href="/profile" class="user-name-link" style="cursor: pointer; text-decoration: none; color: var(--text-secondary); transition: color 0.2s;">
                        <span class="text-secondary">${currentUser.full_name || currentUser.username}</span>
                    </a>
                    <a href="/profile" class="user-avatar-link" style="cursor: pointer; text-decoration: none;">
                        <div class="user-avatar">${getInitials(currentUser.full_name || currentUser.username)}</div>
                    </a>
                    <button class="btn btn-ghost btn-sm" onclick="auth.logout()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
                        </svg>
                    </button>
                `;
            }
        }
        
        async function loadOrganizations() {
            try {
                organizations = await api.getOrganizations();
                populateOrgSelects();
            } catch (error) {
                console.error('Failed to load organizations:', error);
            }
        }
        
        function populateOrgSelects() {
            const selects = ['createDeptOrganization', 'editDeptOrganization'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                select.innerHTML = '<option value="">-- Выберите организацию --</option>';
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    select.appendChild(option);
                });
            });
        }
        
        async function loadDepartments() {
            const tbody = document.getElementById('departmentsTableBody');
            
            try {
                departments = await api.getDepartments();
                renderDepartments();
            } catch (error) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <p>Ошибка загрузки: ${error.message}</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderDepartments() {
            const tbody = document.getElementById('departmentsTableBody');
            
            if (departments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="empty-state">
                                <p>Нет подразделений</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = departments.map(dept => `
                <tr>
                    <td>${dept.id}</td>
                    <td>${escapeHtml(dept.name)}</td>
                    <td>${dept.organization ? escapeHtml(dept.organization.name) : ''}</td>
                    <td>${escapeHtml(dept.description || '')}</td>
                    <td>
                        <div class="flex gap-2" style="justify-content: flex-start;">
                            <button class="btn btn-sm btn-secondary" onclick="openEditDept(${dept.id})">
                                Редактировать
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDept(${dept.id})">
                                Удалить
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function openEditDept(deptId) {
            const dept = departments.find(d => d.id === deptId);
            if (!dept) return;
            
            document.getElementById('editDeptId').value = dept.id;
            document.getElementById('editDeptName').value = dept.name;
            document.getElementById('editDeptOrganization').value = dept.organization_id;
            document.getElementById('editDeptDescription').value = dept.description || '';
            
            openModal('editDeptModal');
        }
        
        async function deleteDept(deptId) {
            if (!confirm('Вы уверены, что хотите удалить это подразделение? Это действие нельзя отменить.')) {
                return;
            }
            
            try {
                await api.deleteDepartment(deptId);
                showAlert('Подразделение удалено', 'success');
                loadDepartments();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        }
        
        // Form handlers
        document.getElementById('createDeptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deptData = {
                name: document.getElementById('createDeptName').value,
                organization_id: parseInt(document.getElementById('createDeptOrganization').value),
                description: document.getElementById('createDeptDescription').value || null
            };
            
            try {
                await api.createDepartment(deptData);
                showAlert('Подразделение создано', 'success');
                closeModal('createDeptModal');
                document.getElementById('createDeptForm').reset();
                loadDepartments();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        });
        
        document.getElementById('editDeptForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const deptId = parseInt(document.getElementById('editDeptId').value);
            const deptData = {
                name: document.getElementById('editDeptName').value,
                organization_id: parseInt(document.getElementById('editDeptOrganization').value),
                description: document.getElementById('editDeptDescription').value || null
            };
            
            try {
                await api.updateDepartment(deptId, deptData);
                showAlert('Подразделение обновлено', 'success');
                closeModal('editDeptModal');
                loadDepartments();
            } catch (error) {
                showAlert('Ошибка: ' + error.message, 'error');
            }
        });
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        init();
    </script>
</body>
</html>

